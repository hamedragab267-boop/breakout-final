<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Breakout Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
body{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; font-family:'Segoe UI',sans-serif;}
.card{background:rgba(255,255,255,.1); border:none; border-radius:20px; backdrop-filter:blur(10px); margin-bottom:20px; padding:20px;}
table input{width:100%; border-radius:8px; border:none; padding:4px;}
button{border-radius:10px!important; font-weight:bold; cursor:pointer;}
#toast{position:fixed; bottom:20px; right:20px; background:#00ffcc; color:#000; padding:12px 25px; border-radius:25px; opacity:0; transition:.4s; z-index:2000;}
#toast.show{opacity:1;}
img.drink-img{width:60px; height:60px; object-fit:cover; border-radius:10px;}
.stats{display:flex; gap:20px; margin-bottom:20px;}
.stats div{background:rgba(255,255,255,.1); padding:15px; border-radius:15px; flex:1; text-align:center;}
</style>
</head>
<body class="container py-4">

<h1 class="text-center mb-4 text-info">ðŸ”¥ Admin Dashboard</h1>
<div id="toast"></div>
<button class="btn btn-danger mb-3" onclick="logout()">Logout</button>

<!-- Stats -->
<div class="stats">
  <div>Total Users: <span id="total-users">0</span></div>
  <div>Total Wallet: <span id="total-wallet">0</span> EGY</div>
  <div>Total Points: <span id="total-points">0</span></div>
</div>

<!-- Users Management -->
<div class="card">
<h4>Users Management</h4>
<table class="table table-dark table-hover">
<thead>
<tr>
<th>Email</th>
<th>Phone</th>
<th>Wallet</th>
<th>Points</th>
<th>Role</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="usersTable"></tbody>
</table>
</div>

<!-- Drinks Management -->
<div class="card">
<h4>Drinks Management</h4>
<button class="btn btn-success mb-3" onclick="addNewDrink()">Add New Drink</button>
<table class="table table-dark table-hover">
<thead>
<tr>
<th>Image</th>
<th>Name</th>
<th>Base Price</th>
<th>Flavors</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="drinksTable"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, setDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAubjKdiEqfDpW-tc94-l-AI7lbPs7IU04",
  authDomain: "breakout-d5088.firebaseapp.com",
  projectId: "breakout-d5088",
  storageBucket: "breakout-d5088.appspot.com",
  messagingSenderId: "57071720148",
  appId: "1:57071720148:web:1a628bbb31191efcd41"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const usersTable = document.getElementById("usersTable");
const drinksTable = document.getElementById("drinksTable");
const toast = document.getElementById("toast");
const totalUsers = document.getElementById("total-users");
const totalWallet = document.getElementById("total-wallet");
const totalPoints = document.getElementById("total-points");

function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),2500); }
window.logout = ()=>{ signOut(auth).then(()=>window.location.href="login.html"); }

/* ===== Users Management ===== */
async function loadUsers(){
  usersTable.innerHTML=""; let walletSum=0, pointsSum=0;
  const q = await getDocs(collection(db,"users"));
  totalUsers.textContent = q.size;
  q.forEach(u=>{
    const d = u.data();
    walletSum+=d.wallet||0;
    pointsSum+=d.points||0;
    usersTable.innerHTML += `
      <tr>
        <td>${d.email}</td>
        <td><input value="${d.phone||''}" onchange="updateUserField('${u.id}','phone',this.value)"></td>
        <td>${d.wallet||0}</td>
        <td>${d.points||0}</td>
        <td><input value="${d.role||'user'}" onchange="updateUserField('${u.id}','role',this.value)"></td>
        <td>
          <button class="btn btn-sm btn-success" onclick="rechargeWallet('${u.id}')">Recharge</button>
          <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
        </td>
      </tr>
    `;
  });
  totalWallet.textContent = walletSum;
  totalPoints.textContent = pointsSum;
}

window.updateUserField = async (id,field,value)=>{
  await updateDoc(doc(db,"users",id),{[field]:value});
  showToast("User updated!");
  loadUsers();
}

window.rechargeWallet = async (id)=>{
  const amount = parseInt(prompt("Enter amount to add:"));
  if(isNaN(amount)) return showToast("Invalid number");
  await updateDoc(doc(db,"users",id),{wallet:increment(amount)});
  showToast("Wallet updated!");
  loadUsers();
}

window.deleteUser = async (id)=>{
  if(confirm("Delete this user?")){
    await deleteDoc(doc(db,"users",id));
    showToast("User deleted!");
    loadUsers();
  }
}

/* ===== Drinks Management ===== */
async function loadDrinks(){
  drinksTable.innerHTML = "";
  const q = await getDocs(collection(db,"drinks"));
  q.forEach(d=>{
    const data = d.data();
    const flavors = data.flavors||[];
    const flavorsHtml = flavors.map((f,i)=>`
      <div style="display:flex; gap:5px; margin-bottom:2px;">
        <input value="${f.name}" placeholder="Flavor" onchange="updateFlavor('${d.id}',${i},'name',this.value)">
        <input type="number" value="${f.price}" placeholder="Price" onchange="updateFlavor('${d.id}',${i},'price',this.value)">
      </div>
    `).join('');
    drinksTable.innerHTML += `
      <tr>
        <td><img src="${data.image||''}" class="drink-img" onclick="changeImage('${d.id}')" title="Click to change image"></td>
        <td><input value="${data.name}" onchange="updateField('${d.id}','name',this.value)"></td>
        <td><input type="number" value="${data.basePrice}" onchange="updateField('${d.id}','basePrice',this.value)"></td>
        <td>${flavorsHtml}<button class="btn btn-sm btn-success" onclick="addFlavor('${d.id}')">Add Flavor</button></td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteDrink('${d.id}')">Delete</button></td>
      </tr>
    `;
  });
}

window.updateField = async (id,field,value)=>{
  if(field==="basePrice") value = parseInt(value);
  await updateDoc(doc(db,"drinks",id),{[field]:value});
  showToast("Updated!");
  loadDrinks();
}

window.updateFlavor = async (id,index,field,value)=>{
  const drinkRef = doc(db,"drinks",id);
  const snap = await getDoc(drinkRef);
  const flavors = snap.data().flavors||[];
  if(field==="price") value = parseInt(value);
  flavors[index][field] = value;
  await updateDoc(drinkRef,{flavors});
  showToast("Flavor updated!");
  loadDrinks();
}

window.addFlavor = async (id)=>{
  const name = prompt("Flavor name:");
  const price = parseInt(prompt("Flavor price:"));
  if(!name || isNaN(price)) return showToast("Invalid input");
  const drinkRef = doc(db,"drinks",id);
  const snap = await getDoc(drinkRef);
  const flavors = snap.data().flavors||[];
  flavors.push({name, price});
  await updateDoc(drinkRef,{flavors});
  showToast("Flavor added!");
  loadDrinks();
}

window.changeImage = async (id)=>{
  const fileInput = document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*"; fileInput.click();
  fileInput.onchange = async ()=>{
    const file = fileInput.files[0]; if(!file) return;
    const storageRef = ref(storage,"drinks/"+file.name);
    await uploadBytes(storageRef,file);
    const imageUrl = await getDownloadURL(storageRef);
    await updateDoc(doc(db,"drinks",id),{image:imageUrl});
    showToast("Image updated!");
    loadDrinks();
  }
}

window.addNewDrink = async ()=>{
  const name = prompt("Drink name:"); const basePrice = parseInt(prompt("Base price:"));
  if(!name || isNaN(basePrice)) return showToast("Invalid input");
  const flavorCount = parseInt(prompt("How many flavors?")); const flavors=[];
  for(let i=0;i<flavorCount;i++){
    const fname = prompt(`Flavor ${i+1} name:`); const fprice = parseInt(prompt(`Flavor ${i+1} price:`));
    if(fname && !isNaN(fprice)) flavors.push({name:fname, price:fprice});
  }
  const fileInput = document.createElement("input"); fileInput.type="file"; fileInput.accept="image/*"; fileInput.click();
  fileInput.onchange = async ()=>{
    const file = fileInput.files[0]; if(!file) return;
    const storageRef = ref(storage,"drinks/"+file.name);
    await uploadBytes(storageRef,file);
    const imageUrl = await getDownloadURL(storageRef);
    await setDoc(doc(collection(db,"drinks")), {name, basePrice, flavors, image:imageUrl});
    showToast("Drink added!");
    loadDrinks();
  }
}

window.deleteDrink = async (id)=>{
  if(confirm("Delete this drink?")){
    await deleteDoc(doc(db,"drinks",id));
    showToast("Drink deleted!");
    loadDrinks();
  }
}

/* ===== Auth Guard ===== */
onAuthStateChanged(auth, async(user)=>{
  if(!user) return window.location.href="login.html";
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="admin"){ alert("Access Denied"); signOut(auth); return; }
  loadUsers(); loadDrinks();
});
</script>

</body>
</html>
